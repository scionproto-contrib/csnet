// Copyright 2024 ETH Zurich
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//   http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.

#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "common/as_entry.h"
#include "common/info_field.h"
#include "common/isd_as.h"
#include "data_plane/path.h"
#include "util/linked_list.h"
#include "test_path.h"

int scion_test_init_raw_path(void)
{
	struct scion_path_meta_hdr hdr;
	hdr.curr_inf = 0;
	hdr.curr_hf = 0;
	hdr.seg_len[0] = 2;
	hdr.seg_len[1] = 2;
	hdr.seg_len[2] = 2;

	struct scion_linked_list *info_fields = scion_list_create();

	struct scion_info_field info_field_0;
	info_field_0.peer = false;
	info_field_0.cons_dir = false;
	info_field_0.seg_id = 0x3672;
	info_field_0.timestamp = 0x67375efc;

	struct scion_info_field info_field_1;
	info_field_1.peer = false;
	info_field_1.cons_dir = false;
	info_field_1.seg_id = 0x6d1d;
	info_field_1.timestamp = 0x67375eb3;

	struct scion_info_field info_field_2;
	info_field_2.peer = false;
	info_field_2.cons_dir = true;
	info_field_2.seg_id = 0xf95f;
	info_field_2.timestamp = 0x67375eae;

	scion_list_append(info_fields, &info_field_0);
	scion_list_append(info_fields, &info_field_1);
	scion_list_append(info_fields, &info_field_2);

	struct scion_linked_list *hop_fields = scion_list_create();

	struct scion_hop_field hop_field_0;
	hop_field_0.ingress_router_alert = false;
	hop_field_0.egress_router_alert = false;
	hop_field_0.exp_time = 63;
	hop_field_0.cons_ingress = 2;
	hop_field_0.cons_egress = 0;
	hop_field_0.mac[0] = 0x87;
	hop_field_0.mac[1] = 0x2d;
	hop_field_0.mac[2] = 0x92;
	hop_field_0.mac[3] = 0x63;
	hop_field_0.mac[4] = 0xd1;
	hop_field_0.mac[5] = 0x97;

	struct scion_hop_field hop_field_1;
	hop_field_1.ingress_router_alert = false;
	hop_field_1.egress_router_alert = false;
	hop_field_1.exp_time = 63;
	hop_field_1.cons_ingress = 0;
	hop_field_1.cons_egress = 500;
	hop_field_1.mac[0] = 0xae;
	hop_field_1.mac[1] = 0xe2;
	hop_field_1.mac[2] = 0x32;
	hop_field_1.mac[3] = 0xfe;
	hop_field_1.mac[4] = 0xe4;
	hop_field_1.mac[5] = 0xdf;

	struct scion_hop_field hop_field_2;
	hop_field_2.ingress_router_alert = false;
	hop_field_2.egress_router_alert = false;
	hop_field_2.exp_time = 63;
	hop_field_2.cons_ingress = 502;
	hop_field_2.cons_egress = 0;
	hop_field_2.mac[0] = 0x31;
	hop_field_2.mac[1] = 0x76;
	hop_field_2.mac[2] = 0xc2;
	hop_field_2.mac[3] = 0x99;
	hop_field_2.mac[4] = 0x18;
	hop_field_2.mac[5] = 0xf2;

	struct scion_hop_field hop_field_3;
	hop_field_3.ingress_router_alert = false;
	hop_field_3.egress_router_alert = false;
	hop_field_3.exp_time = 63;
	hop_field_3.cons_ingress = 0;
	hop_field_3.cons_egress = 3;
	hop_field_3.mac[0] = 0xe1;
	hop_field_3.mac[1] = 0x00;
	hop_field_3.mac[2] = 0x16;
	hop_field_3.mac[3] = 0xdf;
	hop_field_3.mac[4] = 0xd5;
	hop_field_3.mac[5] = 0x4b;

	struct scion_hop_field hop_field_4;
	hop_field_4.ingress_router_alert = false;
	hop_field_4.egress_router_alert = false;
	hop_field_4.exp_time = 63;
	hop_field_4.cons_ingress = 0;
	hop_field_4.cons_egress = 4;
	hop_field_4.mac[0] = 0x25;
	hop_field_4.mac[1] = 0x66;
	hop_field_4.mac[2] = 0x37;
	hop_field_4.mac[3] = 0x02;
	hop_field_4.mac[4] = 0x8d;
	hop_field_4.mac[5] = 0xda;

	struct scion_hop_field hop_field_5;
	hop_field_5.ingress_router_alert = false;
	hop_field_5.egress_router_alert = false;
	hop_field_5.exp_time = 63;
	hop_field_5.cons_ingress = 3;
	hop_field_5.cons_egress = 0;
	hop_field_5.mac[0] = 0x2c;
	hop_field_5.mac[1] = 0xad;
	hop_field_5.mac[2] = 0xf3;
	hop_field_5.mac[3] = 0x51;
	hop_field_5.mac[4] = 0xb8;
	hop_field_5.mac[5] = 0xbd;

	scion_list_append(hop_fields, &hop_field_0);
	scion_list_append(hop_fields, &hop_field_1);
	scion_list_append(hop_fields, &hop_field_2);
	scion_list_append(hop_fields, &hop_field_3);
	scion_list_append(hop_fields, &hop_field_4);
	scion_list_append(hop_fields, &hop_field_5);

	struct scion_path_raw raw_path = { 0 };
	int ret = scion_path_raw_init(&raw_path, &hdr, info_fields, hop_fields);

	scion_list_free(info_fields, NULL);
	scion_list_free(hop_fields, NULL);

	if (ret != 0) {
		return ret;
	}

	// clang-format off
	const uint8_t test_buf[] = {
		0x00, 0x00, 0x20, 0x82, 0x00, 0x00, 0x36, 0x72,
		0x67, 0x37, 0x5e, 0xfc, 0x00, 0x00, 0x6d, 0x1d,
		0x67, 0x37, 0x5e, 0xb3, 0x01, 0x00, 0xf9, 0x5f,
		0x67, 0x37, 0x5e, 0xae, 0x00, 0x3f, 0x00, 0x02,
		0x00, 0x00, 0x87, 0x2d, 0x92, 0x63, 0xd1, 0x97,
		0x00, 0x3f, 0x00, 0x00, 0x01, 0xf4, 0xae, 0xe2,
		0x32, 0xfe, 0xe4, 0xdf, 0x00, 0x3f, 0x01, 0xf6,
		0x00, 0x00, 0x31, 0x76, 0xc2, 0x99, 0x18, 0xf2,
		0x00, 0x3f, 0x00, 0x00, 0x00, 0x03, 0xe1, 0x00,
		0x16, 0xdf, 0xd5, 0x4b, 0x00, 0x3f, 0x00, 0x00,
		0x00, 0x04, 0x25, 0x66, 0x37, 0x02, 0x8d, 0xda,
		0x00, 0x3f, 0x00, 0x03, 0x00, 0x00, 0x2c, 0xad,
		0xf3, 0x51, 0xb8, 0xbd,
	};
	// clang-format on

	if (raw_path.length != sizeof(test_buf)) {
		free(raw_path.raw);
		return 1;
	}

	ret = (memcmp(raw_path.raw, &test_buf, raw_path.length) != 0);
	free(raw_path.raw);

	return ret;
}

int scion_test_reverse_path(void)
{
	// clang-format off
    // Path from AS 222 to AS 133
    uint8_t raw_path_buf[] = {
		0x8a, 0x00, 0x31, 0x04, 0x00, 0x00, 0xbc, 0xa0,
        0x67, 0x3c, 0x94, 0x2c, 0x00, 0x00, 0x1d, 0x45,
        0x67, 0x3c, 0x94, 0x2a, 0x01, 0x00, 0xa8, 0x81,
        0x67, 0x3c, 0x94, 0x24, 0x00, 0x3f, 0x01, 0x2d,
        0x00, 0x00, 0x52, 0xec, 0x27, 0xb3, 0x93, 0x97,
        0x00, 0x3f, 0x00, 0x07, 0x00, 0x04, 0x1c, 0xe0,
        0xb5, 0xd5, 0x20, 0xe0, 0x00, 0x3f, 0x00, 0x00,
        0x01, 0xc3, 0xb4, 0xf1, 0xbd, 0xd5, 0xf7, 0xa7,
        0x00, 0x3f, 0x01, 0xc2, 0x00, 0x00, 0x27, 0xdb,
        0xf5, 0xaa, 0xc9, 0x74, 0x00, 0x3f, 0x01, 0xf6,
        0x01, 0xf7, 0x8b, 0xf1, 0x12, 0x69, 0xa4, 0xd1,
        0x00, 0x3f, 0x00, 0x01, 0x00, 0x03, 0xc9, 0x98,
        0x08, 0x95, 0xd8, 0x17, 0x00, 0x3f, 0x00, 0x00,
        0x00, 0x69, 0x4c, 0x02, 0x3b, 0xd3, 0x7b, 0xc3,
        0x00, 0x3f, 0x00, 0x00, 0x00, 0x6f, 0x3d, 0x29,
        0x57, 0xdd, 0xce, 0x40, 0x00, 0x3f, 0x01, 0xdf,
        0x01, 0xde, 0x90, 0x83, 0x9b, 0xd1, 0x33, 0x97,
        0x00, 0x3f, 0x00, 0x02, 0x00, 0x01, 0x02, 0x15,
        0xf3, 0x9f, 0x69, 0x22, 0x00, 0x3f, 0x00, 0x02,
        0x00, 0x00, 0x7b, 0x26, 0x93, 0x71, 0x4f, 0x5b,
	};

    // Path reversed by Go code, now from AS 133 to AS 222
    uint8_t test_buf[] = {
        0x00, 0x00, 0x41, 0x03, 0x00, 0x00, 0xa8, 0x81,
        0x67, 0x3c, 0x94, 0x24, 0x01, 0x00, 0x1d, 0x45,
        0x67, 0x3c, 0x94, 0x2a, 0x01, 0x00, 0xbc, 0xa0,
        0x67, 0x3c, 0x94, 0x2c, 0x00, 0x3f, 0x00, 0x02,
        0x00, 0x00, 0x7b, 0x26, 0x93, 0x71, 0x4f, 0x5b,
        0x00, 0x3f, 0x00, 0x02, 0x00, 0x01, 0x02, 0x15,
        0xf3, 0x9f, 0x69, 0x22, 0x00, 0x3f, 0x01, 0xdf,
        0x01, 0xde, 0x90, 0x83, 0x9b, 0xd1, 0x33, 0x97,
        0x00, 0x3f, 0x00, 0x00, 0x00, 0x6f, 0x3d, 0x29,
        0x57, 0xdd, 0xce, 0x40, 0x00, 0x3f, 0x00, 0x00,
        0x00, 0x69, 0x4c, 0x02, 0x3b, 0xd3, 0x7b, 0xc3,
        0x00, 0x3f, 0x00, 0x01, 0x00, 0x03, 0xc9, 0x98,
        0x08, 0x95, 0xd8, 0x17, 0x00, 0x3f, 0x01, 0xf6,
        0x01, 0xf7, 0x8b, 0xf1, 0x12, 0x69, 0xa4, 0xd1,
        0x00, 0x3f, 0x01, 0xc2, 0x00, 0x00, 0x27, 0xdb,
        0xf5, 0xaa, 0xc9, 0x74, 0x00, 0x3f, 0x00, 0x00,
        0x01, 0xc3, 0xb4, 0xf1, 0xbd, 0xd5, 0xf7, 0xa7,
        0x00, 0x3f, 0x00, 0x07, 0x00, 0x04, 0x1c, 0xe0,
        0xb5, 0xd5, 0x20, 0xe0, 0x00, 0x3f, 0x01, 0x2d,
        0x00, 0x00, 0x52, 0xec, 0x27, 0xb3, 0x93, 0x97,
    };
	// clang-format on

	struct scion_path_raw raw_path = { 0 };
	raw_path.length = sizeof(raw_path_buf);
	raw_path.raw = (uint8_t *)&raw_path_buf;

	int ret = scion_path_raw_reverse(&raw_path);
	if (ret < 0) {
		return ret;
	}

	return (memcmp(&test_buf, &raw_path_buf, sizeof(test_buf)) != 0);
}
